var expect   = require('chai').expect;
var sinon    = require('sinon');
var fs       = require('fs');
var Consumer = require('./index');

describe('Consumer', function () {
  afterEach(function () {
    Consumer.cache = {};
  });

  describe('#insertIntoCache', function () {
    it('inserts result into cache, keyed by the expression', function () {
      var expression = "2+3=";
      var result     = 5;

      Consumer.prototype.insertIntoCache(expression, result);

      expect(Consumer.cache[expression]).to.equal(result);
    });
  });

  describe('#getFromCache', function () {
    it('returns the result when present', function () {
      var expression = "2+2=";
      var result     = 4;
      var cached;

      Consumer.prototype.insertIntoCache(expression, result);

      cached = Consumer.prototype.getFromCache(expression);

      expect(cached).to.equal(result);
    });

    it('returns undefined when result is not present', function () {
      var cached = Consumer.prototype.getFromCache('1+1=');

      expect(cached).not.to.exist;
    });
  });

  describe('#validateExpression', function () {
    it('validates 2 operand expressions', function () {
      var expressions = [
        '2+2=', '2+7=', '0+8=', '15153+23=', '234235+254634=',
        '2*2=', '2*7=', '0*8=', '15153*23=', '234235*254634=',
        '2-2=', '2-7=', '0-8=', '15153-23=', '234235-254634=',
      ];

      expressions.forEach(function (expression) {
        expect(Consumer.prototype.validateExpression(expression)).to.be.true;
      });
    });

    it('validates 3 operand expressions', function () {
      var expressions = [
        '2+2+5=', '2+7+5=', '0+8+5=', '15153+23+5=', '234235+254634+5=',
        '2*2*5=', '2*7*5=', '0*8*5=', '15153*23*5=', '234235*254634*5=',
        '2-2-5=', '2-7-5=', '0-8-5=', '15153-23-5=', '234235-254634-5=',
      ];

      expressions.forEach(function (expression) {
        expect(Consumer.prototype.validateExpression(expression)).to.be.true;
      });
    });

    it('validates 5+ operand expressions', function () {
      var expressions = [
        '2+3+5+4+6=', '2+3+5+4+6+22+1616+7+2+1634257+23+7='
      ];

      expressions.forEach(function (expression) {
        expect(Consumer.prototype.validateExpression(expression)).to.be.true;
      });
    });

    it('rejects bad expressions', function () {
      var bad_expressions = [
        '-2+5=', 'alphapig', '', 7, '8++7=', undefined
      ];

      bad_expressions.forEach(function (expression) {
        expect(Consumer.prototype.validateExpression(expression)).to.be.false;
      });
    });
  });

  describe('#logResults', function () {
    afterEach(function () {
      Consumer.logs = [];
    });

    it('adds the result to Consumer.logs', function () {
      Consumer.prototype.logResults('"2+1=" resulted in 3');
      Consumer.prototype.logResults('"!+void=" resulted in an error');

      expect(Consumer.logs.length).to.equal(2);
    });
  });

  describe('#writeLogsToFile', function () {
    it('does NOT call fs.appendFile if writeLogs is falsey', function () {
      var stub = sinon.stub(fs, 'appendFile');

      Consumer.prototype.writeLogsToFile.call({options:{}});

      expect(stub.called).to.be.false;

      stub.restore();
    });

    it('DOES call fs.appendFile if writeLogs is true', function () {
      var stub = sinon.stub(fs, 'appendFile');

      Consumer.prototype.writeLogsToFile.call({options:{writeLogs: true}});

      expect(stub.called).to.be.true;

      stub.restore();
    });
  });

  describe('#evaluateExpression', function () {
    it('correctly evaluates addition expressions with two operators', function () {
      var result = Consumer.prototype.evaluateExpression('2+3=');

      expect(result).to.equal(5);
    });

    it('correctly evaluates addition expressions with multiple operators', function () {
      var result = Consumer.prototype.evaluateExpression('2+7+1056+34=');

      expect(result).to.equal(1099);
    });

    it('correctly evaluates subtraction expressions with two operators', function () {
      var result = Consumer.prototype.evaluateExpression('3-2=');

      expect(result).to.equal(1);
    });

    it('correctly evaluates subtraction expressions with multiple operators', function () {
      var result = Consumer.prototype.evaluateExpression('102-2-7-25=');

      expect(result).to.equal(68);
    });

    it('correctly evaluates multiplication expressions with two operators', function () {
      var result = Consumer.prototype.evaluateExpression('2*3=');

      expect(result).to.equal(6);
    });

    it('correctly evaluates multiplication expressions with multiple operators', function () {
      var result = Consumer.prototype.evaluateExpression('2*25*10*10=');

      expect(result).to.equal(5000);
    });
  });
});
