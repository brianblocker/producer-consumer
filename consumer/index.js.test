var expect   = require('chai').expect;
var sinon    = require('sinon');
var fs       = require('fs');
var winston  = require('winston');
var Consumer = require('./index');

describe('Consumer', function () {
  afterEach(function () {
    Consumer.cache = Object.create(null);
    Consumer.logs  = [];
  });

  describe('#insertIntoCache', function () {
    it('inserts result into cache, keyed by the expression', function () {
      var expression = "2+3=";
      var result     = 5;

      Consumer.prototype.insertIntoCache(expression, result);

      expect(Consumer.cache[expression]).to.equal(result);
    });
  });

  describe('#getFromCache', function () {
    it('returns the result when present', function () {
      var expression = "2+2=";
      var result     = 4;
      var cached;

      Consumer.prototype.insertIntoCache(expression, result);

      cached = Consumer.prototype.getFromCache(expression);

      expect(cached).to.equal(result);
    });

    it('returns undefined when result is not present', function () {
      var cached = Consumer.prototype.getFromCache('1+1=');

      expect(cached).not.to.exist;
    });
  });

  describe('#validateExpression', function () {
    it('validates 2 operand expressions', function () {
      var expressions = [
        '2+2=', '2+7=', '0+8=', '15153+23=', '234235+254634=',
        '2*2=', '2*7=', '0*8=', '15153*23=', '234235*254634=',
        '2-2=', '2-7=', '0-8=', '15153-23=', '234235-254634=',
      ];

      expressions.forEach(function (expression) {
        expect(Consumer.prototype.validateExpression(expression)).to.be.true;
      });
    });

    it('validates 3 operand expressions', function () {
      var expressions = [
        '2+2+5=', '2+7+5=', '0+8+5=', '15153+23+5=', '234235+254634+5=',
        '2*2*5=', '2*7*5=', '0*8*5=', '15153*23*5=', '234235*254634*5=',
        '2-2-5=', '2-7-5=', '0-8-5=', '15153-23-5=', '234235-254634-5=',
      ];

      expressions.forEach(function (expression) {
        expect(Consumer.prototype.validateExpression(expression)).to.be.true;
      });
    });

    it('validates 5+ operand expressions', function () {
      var expressions = [
        '2+3+5+4+6=', '2+3+5+4+6+22+1616+7+2+1634257+23+7='
      ];

      expressions.forEach(function (expression) {
        expect(Consumer.prototype.validateExpression(expression)).to.be.true;
      });
    });

    it('rejects bad expressions', function () {
      var bad_expressions = [
        '-2+5=', 'alphapig', '', 7, '8++7=', undefined
      ];

      bad_expressions.forEach(function (expression) {
        expect(Consumer.prototype.validateExpression(expression)).to.be.false;
      });
    });
  });

  describe('#addToLog', function () {
    it('adds the result to logger', function () {
      var spy = sinon.spy(winston, 'info');

      Consumer.prototype.addToLog('"2+1=" resulted in 3');

      expect(spy.called).to.equal(true);

      spy.restore();
    });
  });

  describe('#evaluateExpression', function () {
    it('correctly evaluates addition expressions with two operators', function () {
      var result = Consumer.prototype.evaluateExpression('2+3=');

      expect(result).to.equal(5);
    });

    it('correctly evaluates addition expressions with multiple operators', function () {
      var result = Consumer.prototype.evaluateExpression('2+7+1056+34=');

      expect(result).to.equal(1099);
    });

    it('correctly evaluates subtraction expressions with two operators', function () {
      var result = Consumer.prototype.evaluateExpression('3-2=');

      expect(result).to.equal(1);
    });

    it('correctly evaluates subtraction expressions with multiple operators', function () {
      var result = Consumer.prototype.evaluateExpression('102-2-7-25=');

      expect(result).to.equal(68);
    });

    it('correctly evaluates multiplication expressions with two operators', function () {
      var result = Consumer.prototype.evaluateExpression('2*3=');

      expect(result).to.equal(6);
    });

    it('correctly evaluates multiplication expressions with multiple operators', function () {
      var result = Consumer.prototype.evaluateExpression('2*25*10*10=');

      expect(result).to.equal(5000);
    });
  });

  describe('#getResult', function () {
    beforeEach(function () {
      this.consumer = new Consumer();

      this.good_expression   = '2+3=';
      this.expression_result = 5;
      this.bad_expression    = 'Balsamiq';
    });

    it('calls #validateExpression', function () {
      var spy = sinon.spy(Consumer.prototype, 'validateExpression');

      this.consumer.getResult(this.good_expression);

      expect(spy.args[0][0]).to.equal(this.good_expression);

      spy.restore();
    });

    it('calls #evaluateExpression', function () {
      var spy = sinon.spy(Consumer.prototype, 'evaluateExpression');

      this.consumer.getResult(this.good_expression);

      expect(spy.args[0][0]).to.equal(this.good_expression);

      spy.restore();
    });

    it('returns "invalid expression" if #validateExpression fails', function () {
      var result = this.consumer.getResult(this.bad_expression);

      expect(result).to.equal('"invalid expression"');
    });

    it('returns the result of #evaluateExpression', function () {
      var result = this.consumer.getResult(this.good_expression);

      expect(result).to.equal(this.expression_result);
    });
  });

  describe('#handleRequest', function () {
    beforeEach(function () {
      this.consumer = new Consumer();

      this.good_expression   = '2+3=';
      this.expression_result = 5;
      this.cached_expression = '5+6=';
      this.cached_result     = 11;
      this.bad_expression    = 'Balsamiq';

      Consumer.cache[this.cached_expression] = this.cached_result;
    });

    it('calls #getFromCache, passing the expression', function () {
      var spy = sinon.spy(Consumer.prototype, 'getFromCache');

      this.consumer.handleRequest(this.good_expression);

      expect(spy.args[0][0]).to.equal(this.good_expression);

      spy.restore();
    });

    it('passes the correct message to #addToLog when expression is received', function () {
      var spy = sinon.spy(Consumer.prototype, 'addToLog');

      this.consumer.handleRequest(this.good_expression);

      expect(spy.args[0][0]).to.equal('Received ' + this.good_expression + ' from client');

      spy.restore();
    });

    it('calls #getResult, passing the expression, if result is not cached', function () {
      var spy = sinon.spy(Consumer.prototype, 'getResult');

      this.consumer.handleRequest(this.good_expression);

      expect(spy.args[0][0]).to.equal(this.good_expression);

      spy.restore();
    });

    it('does NOT call #getResult if the expression is cached', function () {
      var spy = sinon.spy(Consumer.prototype, 'getResult');

      this.consumer.handleRequest(this.cached_expression);

      expect(spy.called).to.equal(false);

      spy.restore();
    });

    it('does NOT call #insertIntoCache if the expression is cached', function () {
      var spy = sinon.spy(Consumer.prototype, 'insertIntoCache');

      this.consumer.handleRequest(this.cached_expression);

      expect(spy.called).to.equal(false);

      spy.restore();
    });

    it('calls #insertIntoCache, passing result', function () {
      var spy = sinon.spy(Consumer.prototype, 'insertIntoCache');

      this.consumer.handleRequest(this.good_expression);

      expect(spy.args[0][0]).to.equal(this.expression_result);

      spy.restore();
    });

    it('passes the correct message to #addToLog when it has a good result', function () {
      var spy    = sinon.spy(Consumer.prototype, 'addToLog');
      var result = this.expression_result;

      this.consumer.handleRequest(this.good_expression);

      expect(spy.args[1][0]).to.equal(['Returning result of', this.good_expression, 'as', result, 'to client'].join(' '));

      spy.restore();
    });

    it('passes the correct message to #addToLog when it has a bad result', function () {
      var spy = sinon.spy(Consumer.prototype, 'addToLog');

      this.consumer.handleRequest(this.bad_expression);

      expect(spy.args[1][0]).to.equal(['Returning result of', this.bad_expression, 'as "invalid expression" to client'].join(' '));

      spy.restore();
    });

    it('returns the result when result is already cached', function () {
      var result = this.consumer.handleRequest(this.cached_expression);

      expect(result).to.equal(this.cached_result);
    });

    it('returns the result when result is NOT cached', function () {
      var result = this.consumer.handleRequest(this.good_expression);

      expect(result).to.equal(this.expression_result);
    });
  });
});
